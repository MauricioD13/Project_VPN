FROM smallstep/step-ca:latest

# Create required directories
#RUN mkdir -p /data/step /etc/step-ca

# Initialize the CA with strong password and restricted access
RUN step ca init \
    --name "CA_server" \
    --dns "internal-ca.yourdomain.local" \
    --provisioner "ca-admin" \
    --password-file /dev/urandom \
    2>&1 | tee /etc/step-ca/init.log

# Remove password file for enhanced security
RUN rm -f /dev/urandom

# Expose port for internal communication (not publicly accessible)
EXPOSE 9000

# Start the CA server with restricted network access
CMD ["step", "server", "-t", "-c", "/etc/step-ca/config.hcl", "--disable-http"]

# Additional optional security measures:
# - Mount data and config volumes from a dedicated host for persistence
# - Run the container with limited network capabilities
# - Configure role-based access control for provisioners and issuers
